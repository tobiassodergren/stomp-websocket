// Generated by CoffeeScript 1.8.0
/*
   Stomp Over WebSocket http://www.jmesnil.net/stomp-websocket/doc/ | Apache License V2.0

   Copyright (C) 2010-2013 [Jeff Mesnil](http://jmesnil.net/)
   Copyright (C) 2012 [FuseSource, Inc.](http://fusesource.com)
 */
(function(){var t,e,n,r,s={}.hasOwnProperty,o=[].slice;t={LF:"\n",NULL:"\x00"};n=function(){var e;function n(t,e,n){this.command=t;this.headers=e!=null?e:{};this.body=n!=null?n:""}n.prototype.toString=function(){var e,i,r,o,u;e=[this.command];r=this.headers["content-length"]===false?true:false;if(r){delete this.headers["content-length"]}u=this.headers;for(i in u){if(!s.call(u,i))continue;o=u[i];e.push(""+i+":"+o)}if(this.body&&!r){e.push("content-length:"+n.sizeOfUTF8(this.body))}e.push(t.LF+this.body);return e.join(t.LF)};n.sizeOfUTF8=function(t){if(t){return encodeURI(t).match(/%..|./g).length}else{return 0}};e=function(e){var i,r,s,o,u,a,c,f,h,l,p,d,g,b,m,v,y;o=e.search(RegExp(""+t.LF+t.LF));u=e.substring(0,o).split(t.LF);s=u.shift();a={};d=function(t){return t.replace(/^\s+|\s+$/g,"")};v=u.reverse();for(g=0,m=v.length;g<m;g++){l=v[g];f=l.indexOf(":");a[d(l.substring(0,f))]=d(l.substring(f+1))}i="";p=o+2;if(a["content-length"]){h=parseInt(a["content-length"]);i=(""+e).substring(p,p+h)}else{r=null;for(c=b=p,y=e.length;p<=y?b<y:b>y;c=p<=y?++b:--b){r=e.charAt(c);if(r===t.NULL){break}i+=r}}return new n(s,a,i)};n.unmarshall=function(n){var i,r,s,o;r=n.split(RegExp(""+t.NULL+t.LF+"*"));o={frames:[],partial:""};o.frames=function(){var t,n,s,o;s=r.slice(0,-1);o=[];for(t=0,n=s.length;t<n;t++){i=s[t];o.push(e(i))}return o}();s=r.slice(-1)[0];if(s===t.LF||s.search(RegExp(""+t.NULL+t.LF+"*$"))!==-1){o.frames.push(e(s))}else{o.partial=s}return o};n.marshall=function(e,i,r){var s;s=new n(e,i,r);return s.toString()+t.NULL};return n}();e=function(){var e;function s(t){this.ws=t;this.ws.binaryType="arraybuffer";this.counter=0;this.connected=false;this.heartbeat={outgoing:1e4,incoming:1e4};this.maxWebSocketFrameSize=16*1024;this.subscriptions={};this.partialData=""}s.prototype.debug=function(t){var e;return typeof window!=="undefined"&&window!==null?(e=window.console)!=null?e.log(t):void 0:void 0};e=function(){if(Date.now){return Date.now()}else{return(new Date).valueOf}};s.prototype._transmit=function(t,e,i){var r;r=n.marshall(t,e,i);if(typeof this.debug==="function"){this.debug(">>> "+r)}while(true){if(r.length>this.maxWebSocketFrameSize){this.ws.send(r.substring(0,this.maxWebSocketFrameSize));r=r.substring(this.maxWebSocketFrameSize);if(typeof this.debug==="function"){this.debug("remaining = "+r.length)}}else{return this.ws.send(r)}}};s.prototype._setupHeartbeat=function(n){var i,s,o,u,a,c;if((a=n.version)!==r.VERSIONS.V1_1&&a!==r.VERSIONS.V1_2){return}c=function(){var t,e,i,r;i=n["heart-beat"].split(",");r=[];for(t=0,e=i.length;t<e;t++){u=i[t];r.push(parseInt(u))}return r}(),s=c[0],i=c[1];if(!(this.heartbeat.outgoing===0||i===0)){o=Math.max(this.heartbeat.outgoing,i);if(typeof this.debug==="function"){this.debug("send PING every "+o+"ms")}this.pinger=r.setInterval(o,function(e){return function(){e.ws.send(t.LF);return typeof e.debug==="function"?e.debug(">>> PING"):void 0}}(this))}if(!(this.heartbeat.incoming===0||s===0)){o=Math.max(this.heartbeat.incoming,s);if(typeof this.debug==="function"){this.debug("check PONG every "+o+"ms")}return this.ponger=r.setInterval(o,function(t){return function(){var n;n=e()-t.serverActivity;if(n>o*2){if(typeof t.debug==="function"){t.debug("did not receive server activity for the last "+n+"ms")}return t.ws.close()}}}(this))}};s.prototype._parseConnect=function(){var t,e,n,i;t=1<=arguments.length?o.call(arguments,0):[];i={};switch(t.length){case 2:i=t[0],e=t[1];break;case 3:if(t[1]instanceof Function){i=t[0],e=t[1],n=t[2]}else{i.login=t[0],i.passcode=t[1],e=t[2]}break;case 4:i.login=t[0],i.passcode=t[1],e=t[2],n=t[3];break;default:i.login=t[0],i.passcode=t[1],e=t[2],n=t[3],i.host=t[4]}return[i,e,n]};s.prototype.connect=function(){var s,u,a,c;s=1<=arguments.length?o.call(arguments,0):[];c=this._parseConnect.apply(this,s);a=c[0],this.connectCallback=c[1],u=c[2];if(typeof this.debug==="function"){this.debug("Opening Web Socket...")}this.ws.onmessage=function(r){return function(s){var o,a,c,f,h,l,p,d,g,b,m,v,y,w,S,k,I,N;g=typeof ArrayBuffer!=="undefined"&&s.data instanceof ArrayBuffer?(o=new Uint8Array(s.data),typeof r.debug==="function"?r.debug("--- got data length: "+o.length):void 0,l=String.fromCharCode,function(){var t;t=[];while(i<o.length){a=o[i++];if(a<128){t.push(l(a))}else if(a>=194&&a<224){c=o[i++];t.push(l(((a&31)<<6)+(c&63)))}else if(a>=224&&a<240){c=o[i++];f=o[i++];t.push(l(((a&255)<<12)+((c&63)<<6)+(f&63)))}else if(a>=240&&a<245){c=o[i++];f=o[i++];h=o[i++];d=((a&7)<<18)+((c&63)<<12)+((f&63)<<6)+(h&63);d-=65536;t.push(l((d>>10)+55296,(d&1023)+56320))}else{t.push(void 0)}}return t}().join("")):s.data;r.serverActivity=e();if(g===t.LF){if(typeof r.debug==="function"){r.debug("<<< PONG")}return}if(typeof r.debug==="function"){r.debug("<<< "+g)}w=n.unmarshall(r.partialData+g);r.partialData=w.partial;I=w.frames;N=[];for(S=0,k=I.length;S<k;S++){b=I[S];switch(b.command){case"CONNECTED":if(typeof r.debug==="function"){r.debug("connected to server "+b.headers.server)}r.connected=true;r._setupHeartbeat(b.headers);N.push(typeof r.connectCallback==="function"?r.connectCallback(b):void 0);break;case"MESSAGE":y=b.headers.subscription;v=r.subscriptions[y]||r.onreceive;if(v){p=r;m=b.headers["message-id"];b.ack=function(t){if(t==null){t={}}return p.ack(m,y,t)};b.nack=function(t){if(t==null){t={}}return p.nack(m,y,t)};N.push(v(b))}else{N.push(typeof r.debug==="function"?r.debug("Unhandled received MESSAGE: "+b):void 0)}break;case"RECEIPT":N.push(typeof r.onreceipt==="function"?r.onreceipt(b):void 0);break;case"ERROR":N.push(typeof u==="function"?u(b):void 0);break;default:N.push(typeof r.debug==="function"?r.debug("Unhandled frame: "+b):void 0)}}return N}}(this);this.ws.onclose=function(t){return function(){var e;e="Whoops! Lost connection to "+t.ws.url;if(typeof t.debug==="function"){t.debug(e)}t._cleanUp();return typeof u==="function"?u(e):void 0}}(this);return this.ws.onopen=function(t){return function(){if(typeof t.debug==="function"){t.debug("Web Socket Opened...")}a["accept-version"]=r.VERSIONS.supportedVersions();a["heart-beat"]=[t.heartbeat.outgoing,t.heartbeat.incoming].join(",");return t._transmit("CONNECT",a)}}(this)};s.prototype.disconnect=function(t,e){if(e==null){e={}}this._transmit("DISCONNECT",e);this.ws.onclose=null;this.ws.close();this._cleanUp();return typeof t==="function"?t():void 0};s.prototype._cleanUp=function(){this.connected=false;if(this.pinger){r.clearInterval(this.pinger)}if(this.ponger){return r.clearInterval(this.ponger)}};s.prototype.send=function(t,e,n){if(e==null){e={}}if(n==null){n=""}e.destination=t;return this._transmit("SEND",e,n)};s.prototype.subscribe=function(t,e,n){var i;if(n==null){n={}}if(!n.id){n.id="sub-"+this.counter++}n.destination=t;this.subscriptions[n.id]=e;this._transmit("SUBSCRIBE",n);i=this;return{id:n.id,unsubscribe:function(){return i.unsubscribe(n.id)}}};s.prototype.unsubscribe=function(t){delete this.subscriptions[t];return this._transmit("UNSUBSCRIBE",{id:t})};s.prototype.begin=function(t){var e,n;n=t||"tx-"+this.counter++;this._transmit("BEGIN",{transaction:n});e=this;return{id:n,commit:function(){return e.commit(n)},abort:function(){return e.abort(n)}}};s.prototype.commit=function(t){return this._transmit("COMMIT",{transaction:t})};s.prototype.abort=function(t){return this._transmit("ABORT",{transaction:t})};s.prototype.ack=function(t,e,n){if(n==null){n={}}n["message-id"]=t;n.subscription=e;return this._transmit("ACK",n)};s.prototype.nack=function(t,e,n){if(n==null){n={}}n["message-id"]=t;n.subscription=e;return this._transmit("NACK",n)};return s}();r={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.1,1.0"}},client:function(t,n){var i,s;if(n==null){n=["v10.stomp","v11.stomp"]}i=r.WebSocketClass||WebSocket;s=new i(t,n);return new e(s)},over:function(t){return new e(t)},Frame:n};if(typeof exports!=="undefined"&&exports!==null){exports.Stomp=r}if(typeof window!=="undefined"&&window!==null){r.setInterval=function(t,e){return window.setInterval(e,t)};r.clearInterval=function(t){return window.clearInterval(t)};window.Stomp=r}else if(!exports){self.Stomp=r}}).call(this);